<app-open-navbar></app-open-navbar>
<app-centered-card
    imageUrl="/assets/logo-img.jpg"
>
    <div *ngIf="loading" class="align-middle text-center" style="padding-top:25%">
        <div class="spinner-border m-5" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>

    <div *ngIf="!loading && error" class="alert alert-danger mt-3" role="alert">
        {{ error }}
    </div>

    <div *ngIf="!loading && !error" class="d-flex justify-content-center mt-2">
        <div class="py-1 px-2 mb-0">
            Authorizing
        </div>
    </div>

    <!-- Show client info below the image, similar to Sign Up page -->
    <div *ngIf="!loading && !error" class="d-flex justify-content-center">
        <div class="h5 py-1 px-2 mb-0">
            {{ clientId }}
        </div>
    </div>

    <!-- Use one FormGroup with conditional fields -->
    <form
        (ngSubmit)="loginForm.valid && onSubmit()"
        *ngIf="!isLoggedIn && !error"
        [formGroup]="loginForm"
        class="mt-3"
        novalidate
    >
        

        <!-- If client_id is frozen, show username/password inputs + Login button -->
        <div *ngIf="freezeClientId">
            <div class="form-group">
                <label for="username">Username</label>
                <div class="input-group">
                    <span class="input-group-text">&#64;</span>
                    <input
                        class="form-control"
                        formControlName="username"
                        id="username"
                        placeholder="Enter Username / Email"
                        type="text"
                    />
                </div>
                <div
                    *ngIf="loginForm.get('username')?.errors && (loginForm.get('username')?.touched || loginForm.get('username')?.dirty)"
                    class="alert alert-danger mt-2"
                    role="alert">
                    Username is required
                </div>
            </div>

            <div class="form-group mt-3">
                <label for="password">Password</label>
                <div class="input-group">
                    <input
                        [type]="isPasswordVisible ? 'text' : 'password'"
                        class="form-control"
                        formControlName="password"
                        id="password"
                        minlength="6"
                        placeholder="Password"
                    />
                    <button
                        (click)="isPasswordVisible = !isPasswordVisible"
                        class="input-group-text"
                        type="button"
                    >
                        <i class="fa fas {{ !isPasswordVisible ? 'fa-eye' : 'fa-eye-slash' }}"></i>
                    </button>
                </div>
                <div
                    *ngIf="loginForm.get('password')?.errors && (loginForm.get('password')?.touched || loginForm.get('password')?.dirty)"
                    class="alert alert-danger mt-2"
                    role="alert">
                    <div *ngIf="loginForm.get('password')?.errors?.['required']">
                        Password is required
                    </div>
                    <div *ngIf="loginForm.get('password')?.errors?.['minlength']">
                        Password must be at least 6 characters
                    </div>
                </div>
            </div>

            

            <div class="form-group d-grid gap-2 py-3">
                <button [disabled]="loginForm.invalid"
                        class="btn btn-primary btn-block btn-lg"
                        id="login-btn">
                    Login
                </button>
            </div>

            <div *ngIf="isLoginFailed" class="alert alert-danger" role="alert">
                Login failed: {{ errorMessage }}
            </div>
        </div>
    </form>

    <!-- Show confirmation if user is logged in -->
    <div *ngIf="isLoggedIn" class="alert alert-success">
        Logged in as {{ loginForm.value?.username }}.
    </div>

    <div *ngIf="!loading && !error" class="d-flex justify-content-evenly">
        <a class="mt-1" href="https://silentsamurai.github.io/auth-server">
            Api Docs
        </a>

        <a
            id="signup-link"
            class="mt-1"
            [routerLink]="['/signup']"
            [queryParamsHandling]="'merge'"
        >
            Sign Up
        </a>
    </div>
</app-centered-card>

