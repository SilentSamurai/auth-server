<app-centered-card
    [title]="client_id"
    imageUrl="/assets/logo-img.jpg"
>
    <div *ngIf="loading" class="align-middle text-center" style="padding-top:25%">
        <div class="spinner-border m-5" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <form
        (ngSubmit)="loginForm.valid && onSubmit()"
        *ngIf="!isLoggedIn"
        [formGroup]="loginForm"
        class="mt-3"
        novalidate
    >
        <!-- Step 1: Ask for Client ID when not frozen -->
        <div *ngIf="!freezeClientId">
            <div class="form-group">
                <label for="client_id">Client Id</label>
                <input
                    class="form-control"
                    formControlName="client_id"
                    id="client_id"
                    placeholder="Enter Client ID"
                    type="text"
                />
            </div>
            <div
                *ngIf="loginForm.get('client_id')?.invalid && (loginForm.get('client_id')?.touched || loginForm.get('client_id')?.dirty)"
                class="alert alert-danger mt-2"
                role="alert">
                Client Id is required.
            </div>

            <div class="form-group d-grid gap-2 py-3">
                <button
                    (click)="onContinue()"
                    [disabled]="loginForm.get('client_id')?.invalid"
                    class="btn btn-primary btn-block btn-lg"
                    id="continue-btn"
                    type="button"
                >
                    Continue
                </button>
            </div>
        </div>

        <!-- Step 2: After freezing client id, show credentials and readonly client id -->
        <div *ngIf="freezeClientId">
            <div class="form-group">
                <label for="username">Username</label>
                <div class="input-group">
                    <span class="input-group-text">&#64;</span>
                    <input
                        class="form-control"
                        formControlName="username"
                        id="username"
                        placeholder="Enter Username / Email"
                        type="text"
                    />
                </div>
                <div
                    *ngIf="loginForm.get('username')?.errors && (loginForm.get('username')?.touched || loginForm.get('username')?.dirty)"
                    class="alert alert-danger mt-2"
                    role="alert">
                    Username is required
                </div>
            </div>

            <div class="form-group mt-3">
                <label for="password">Password</label>
                <div class="input-group">
                    <input
                        [type]="isPasswordVisible ? 'text' : 'password'"
                        class="form-control"
                        formControlName="password"
                        id="password"
                        minlength="6"
                        placeholder="Password"
                    />
                    <button
                        (click)="isPasswordVisible = !isPasswordVisible"
                        class="input-group-text"
                        type="button"
                    >
                        <i class="fas {{ !isPasswordVisible ? 'fa-eye' : 'fa-eye-slash' }}"></i>
                    </button>
                </div>
                <div
                    *ngIf="loginForm.get('password')?.errors && (loginForm.get('password')?.touched || loginForm.get('password')?.dirty)"
                    class="alert alert-danger mt-2"
                    role="alert">
                    <div *ngIf="loginForm.get('password')?.errors?.['required']">
                        Password is required
                    </div>
                    <div *ngIf="loginForm.get('password')?.errors?.['minlength']">
                        Password must be at least 6 characters
                    </div>
                </div>
            </div>

            <div class="form-group mt-3">
                <label for="client_id_frozen">Client Id</label>
                <input
                    class="form-control"
                    formControlName="client_id"
                    id="client_id_frozen"
                    readonly="true"
                    type="text"
                />
            </div>

            <div class="form-group d-grid gap-2 py-3">
                <button [disabled]="loginForm.invalid"
                        class="btn btn-primary btn-block btn-lg"
                        type="submit"
                        id="login-btn">
                    Login
                </button>
            </div>

            <div *ngIf="isLoginFailed" class="alert alert-danger" role="alert">
                Login failed: {{ errorMessage }}
            </div>
        </div>
    </form>

    <div *ngIf="isLoggedIn" class="alert alert-success">
        Logged in as {{ loginForm.value?.username }}.
    </div>

    <div class="d-flex justify-content-evenly">
        <a class="mt-1" href="https://silentsamurai.github.io/auth-server">
            Api Docs
        </a>

        <a class="mt-1" routerLink="/forgot-password">
            Forgot Password
        </a>

        <a class="mt-1" routerLink="/register">
            Sign Up
        </a>
    </div>
</app-centered-card>

